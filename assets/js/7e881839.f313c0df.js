"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1192],{945:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>o,toc:()=>l});var s=n(8040),a=n(5246);const r={slug:"mysql-security",title:"MySQL Security",authors:"jiaqi",tags:["MySQL","Database","Security","JPA"]},i=void 0,o={permalink:"/blog/mysql-security",editUrl:"https://github.com/QubitPi/chatbot-ws/tree/master/docs/blog/2020-09-08-mysql-security.md",source:"@site/blog/2020-09-08-mysql-security.md",title:"MySQL Security",description:"[//]: # (Copyright 2025 Jiaqi Liu. All rights reserved.)",date:"2020-09-08T00:00:00.000Z",formattedDate:"September 8, 2020",tags:[{label:"MySQL",permalink:"/blog/tags/my-sql"},{label:"Database",permalink:"/blog/tags/database"},{label:"Security",permalink:"/blog/tags/security"},{label:"JPA",permalink:"/blog/tags/jpa"}],readingTime:4.77,hasTruncateMarker:!0,authors:[{name:"Jack",title:"Maintainer of ChatbotWS",url:"https://github.com/QubitPi",imageURL:"https://avatars.githubusercontent.com/u/16126939?v=4",key:"jiaqi"}],frontMatter:{slug:"mysql-security",title:"MySQL Security",authors:"jiaqi",tags:["MySQL","Database","Security","JPA"]},unlisted:!1,prevItem:{title:"MySQL Troubleshooting",permalink:"/blog/mysql-troubleshooting"},nextItem:{title:"How to Deal with Polymorphism in MySQL?",permalink:"/blog/mysql-polymorphism"}},c={authorsImageUrls:[void 0]},l=[{value:"How Applications Become Vulnerable to SQL Injection",id:"how-applications-become-vulnerable-to-sql-injection",level:2},{value:"I&#39;m using JPA. I Should be Safe. No",id:"im-using-jpa-i-should-be-safe-no",level:2},{value:"Prevention Techniques",id:"prevention-techniques",level:3},{value:"Parameterized Queries",id:"parameterized-queries",level:4}];function u(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(t.p,{children:["Despite being one of the best-known vulnerabilities, SQL Injection continues to rank on the top spot of the infamous\n",(0,s.jsx)(t.a,{href:"https://owasp.org/www-project-top-ten/",children:"OWASP Top 10's list"})," - now part of the more general Injection class."]}),"\n",(0,s.jsx)(t.h2,{id:"how-applications-become-vulnerable-to-sql-injection",children:"How Applications Become Vulnerable to SQL Injection"}),"\n",(0,s.jsx)(t.p,{children:"Injection attacks work because, for many applications, the only way to execute a given computation is to dynamically\ngenerate code that is in turn run by another system or component. If in the process of generating this code we use\nuntrusted data without proper sanitization, we leave an open door for hackers to exploit"}),"\n",(0,s.jsx)(t.p,{children:"This statement may sound a bit abstract, so let's take look at how this happens in practice with an example:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:'public List<AccountDTO> unsafeFindAccountsByCustomerId(String customerId) throws SQLException {\n    // UNSAFE !!! DON\'T DO THIS !!!\n    String sql = "select "\n            + "customer_id,acc_number,branch_id,balance "\n            + "from Accounts where customer_id = \'"\n            + customerId\n            + "\'";\n    Connection c = dataSource.getConnection();\n    ResultSet rs = c.createStatement().executeQuery(sql);\n    // ...\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:"The problem with this code is obvious: we've put the customerId\u2018s value into the query with no validation at all.\nNothing bad will happen if we're sure that this value will only come from trusted sources, but can we?"}),"\n",(0,s.jsx)(t.p,{children:"Let's imagine that this function is used in a REST API implementation for an account resource. Exploiting this code is\ntrivial: all we have to do is to send a value that, when concatenated with the fixed part of the query, change its\nintended behavior:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"curl -X GET 'http://localhost:8080/accounts?customerId=abc%27%20or%20%271%27=%271'\n"})}),"\n",(0,s.jsx)(t.p,{children:"Assuming the customerId parameter value goes unchecked until it reaches our function, here's what we'd receive:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"abc' or '1' = '1\n"})}),"\n",(0,s.jsx)(t.p,{children:"When we join this value with the fixed part, we get the final SQL statement that will be executed:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"SELECT\n    customer_id,\n    acc_number,\n    branch_id,\n    balance\nFROM\n    Accounts\nWHERE\n    customerId = 'abc' OR '1' = '1'\n"})}),"\n",(0,s.jsx)(t.p,{children:"Probably not what we've wanted..."}),"\n",(0,s.jsx)(t.h2,{id:"im-using-jpa-i-should-be-safe-no",children:"I'm using JPA. I Should be Safe. No"}),"\n",(0,s.jsx)(t.p,{children:"This is a common misconception. JPA and other ORMs relieves us from creating hand-coded SQL statements, but they won't\nprevent us from writing vulnerable code."}),"\n",(0,s.jsx)(t.p,{children:"Let's see how the JPA version of the previous example looks:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:'public List<AccountDTO> unsafeJpaFindAccountsByCustomerId(String customerId) {\n    String jql = "from Account where customerId = \'" + customerId + "\'";\n    TypedQuery<Account> q = em.createQuery(jql, Account.class);\n    return q.getResultList()\n            .stream()\n            .map(this::toAccountDTO)\n            .collect(Collectors.toList());\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:"The same issue we've pointed before is also present here: we're using unvalidated input to create a JPA query, so we're\nexposed to the same kind of exploit here."}),"\n",(0,s.jsx)(t.h3,{id:"prevention-techniques",children:"Prevention Techniques"}),"\n",(0,s.jsx)(t.p,{children:"Now that we know what a SQL injection is, let's see how we can protect our code from this kind of attack. Here we're\nfocusing on a couple of very effective techniques available in Java and other JVM languages, but similar concepts are\navailable to other environments, such as PHP, .Net, Ruby and so forth."}),"\n",(0,s.jsxs)(t.p,{children:["For those looking for a complete list of available techniques, including database-specific ones, the\n",(0,s.jsx)(t.a,{href:"https://www.owasp.org/",children:"OWASP"})," Project maintains a\n",(0,s.jsx)(t.a,{href:"https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html",children:"SQL Injection Prevention Cheat Sheet"}),",\nwhich is a good place to learn more about the subject."]}),"\n",(0,s.jsx)(t.h4,{id:"parameterized-queries",children:"Parameterized Queries"}),"\n",(0,s.jsxs)(t.p,{children:['This technique consists of using prepared statements with the question mark placeholder ("',(0,s.jsx)(t.code,{children:"?"}),"\") in our queries\nwhenever we need to insert a user-supplied value. This is very effective and, unless there's a bug in the JDBC driver's\nimplementation, immune to exploits."]}),"\n",(0,s.jsx)(t.p,{children:"Let's rewrite our example function to use this technique:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:'public List<AccountDTO> safeFindAccountsByCustomerId(String customerId) throws Exception {\n    String sql = "select "\n            + "customer_id, acc_number, branch_id, balance from Accounts"\n            + "where customer_id = ?";\n\n    Connection c = dataSource.getConnection();\n    PreparedStatement p = c.prepareStatement(sql);\n    p.setString(1, customerId);\n    ResultSet rs = p.executeQuery(sql));\n    // omitted - process rows and return an account list\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:["Here we've used the ",(0,s.jsx)(t.code,{children:"prepareStatement()"})," method available in the ",(0,s.jsx)(t.code,{children:"Connection"})," instance to get a\n",(0,s.jsx)(t.code,{children:"PreparedStatement"}),". This interface extends the regular ",(0,s.jsx)(t.code,{children:"Statement"})," interface with several methods that allow us to\nsafely insert user-supplied values in a query before executing it. For JPA, we have a similar feature:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:'String jql = "FROM Account WHERE customerId = :customerId";\nTypedQuery<Account> query = em.createQuery(jql, Account.class)\n        .setParameter("customerId", customerId);\n// Execute query and return mapped results (omitted)\n'})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"As a bonus, this approach usually results in a better performing query, since most databases can cache the query plan\nassociated with a prepared statement."})}),"\n",(0,s.jsx)(t.p,{children:"Please note that this approach only works for placeholders used as values. For instance, we can't use placeholders to\ndynamically change the name of a table:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:'// This WILL NOT WORK !!!\nPreparedStatement p = c.prepareStatement("select count(*) from ?");\np.setString(1, tableName);\n'})}),"\n",(0,s.jsx)(t.p,{children:"Here, JPA won't help either:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:'// This WILL NOT WORK EITHER !!!\nentityManager\n    .createQuery("SELECT COUNT(*) FROM :tableName", Long.class)\n    .setParameter("tableName", tableName);\n    .getSingleResult();\n'})}),"\n",(0,s.jsx)(t.p,{children:"In both cases, we'll get a runtime error."}),"\n",(0,s.jsx)(t.p,{children:"The main reason behind this is the very nature of a prepared statement: database servers use them to cache the query\nplan required to pull the result set, which usually is the same for any possible value. This is not true for table names\nand other constructs available in the SQL language such as columns used in an order by clause."})]})}function h(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},5246:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>o});var s=n(2340);const a={},r=s.createContext(a);function i(e){const t=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);